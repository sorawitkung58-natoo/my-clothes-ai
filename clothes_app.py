import streamlit as st
import google.generativeai as genai
from PIL import Image
import io

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key ---
# ‡∏ô‡∏≥ API Key ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google AI Studio ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
genai.configure(api_key="AIzaSyAxQYxaNDvmSF06N8h8cS4rhzJ4QUCB8io")

# --- 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÅ‡∏≠‡∏õ ---
st.set_page_config(page_title="AI Clothes Changer", layout="centered")
st.title("üëó ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∏‡∏î AI")
st.write("‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏° 9:16")

# --- 3. ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ---
menu = {
    "‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ": ["Bikini", "Qipao (‡∏Å‡∏µ‡πà‡πÄ‡∏û‡πâ‡∏≤)", "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏¢‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß", "‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡πÉ‡∏ô‡πÄ‡πÄ‡∏•‡∏∞‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÉ‡∏ô", "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏î‡∏£‡∏π‡∏õ", "‡∏ú‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏à‡∏∏‡∏î‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏£‡πâ‡∏ô"],
    "‡πÄ‡∏ã‡πá‡∏Å‡∏ã‡∏µ‡πà/‡∏ô‡∏≠‡∏ô": ["‡∏ä‡∏∏‡∏î‡∏ô‡∏≠‡∏ô", "‡∏ä‡∏∏‡∏î‡∏•‡∏π‡∏Å‡πÑ‡∏°‡πâ‡πÄ‡∏ã‡πá‡∏Å‡∏ã‡∏µ‡πà", "‡∏ä‡∏∏‡∏î‡πÄ‡∏ã‡πá‡∏Å‡∏ã‡∏µ‡πà", "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡∏ö‡∏≤‡∏á", "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏î"],
    "‡∏≠‡∏≤‡∏ä‡∏µ‡∏û (‡πÑ‡∏ó‡∏¢)": ["‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡πÑ‡∏ó‡∏¢", "‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÑ‡∏ó‡∏¢", "‡∏´‡∏°‡∏≠‡πÑ‡∏ó‡∏¢", "‡∏£‡∏õ‡∏†.", "‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢"],
    "‡∏™‡∏±‡∏ï‡∏ß‡πå/‡∏°‡∏≤‡∏™‡∏Ñ‡∏≠‡∏ï": ["‡∏ä‡∏∏‡∏î‡∏ä‡πâ‡∏≤‡∏á", "‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏á‡πÇ‡∏ï", "‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏µ", "‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏π", "‡∏ä‡∏∏‡∏î‡πÅ‡∏°‡∏ß", "‡∏ä‡∏∏‡∏î‡πÄ‡∏™‡∏∑‡∏≠", "‡∏ä‡∏∏‡∏î‡∏™‡∏∏‡∏ô‡∏±‡∏Ç", "‡∏ä‡∏∏‡∏î‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢"]
}

col1, col2 = st.columns(2)
with col1:
    category = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", list(menu.keys()))
with col2:
    outfit = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", menu[category])

# --- 4. ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏ü‡πâ‡∏≤) ---
uploaded_file = st.file_uploader("üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á 9:16)", type=["jpg", "jpeg", "png"])

if uploaded_file:
    # ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    img = Image.open(uploaded_file)
    st.image(img, caption="‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö", use_container_width=True)
    
    # --- 5. ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
    if st.button("‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∏‡∏î"):
        if "‡πÉ‡∏™‡πà_API_KEY" in genai.get_default_api_key():
            st.error("‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà API Key ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏£‡∏±‡∏ö!")
        else:
            with st.spinner(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô {outfit} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà..."):
                try:
                    # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Model Gemini 1.5 Flash
                    model = genai.GenerativeModel('gemini-1.5-flash')
                    
                    # ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞ Prompt ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
                    prompt = f"""
                    Task: Change the person's outfit in the provided image to '{outfit}'.
                    Requirements:
                    1. Keep the exact same person's face, features, and hair.
                    2. Keep the exact same background and environment.
                    3. The new outfit '{outfit}' must fit the person's body naturally.
                    4. Maintain the 9:16 aspect ratio.
                    5. Output should be a high-quality description and visualization.
                    """
                    
                    response = model.generate_content([prompt, img])
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                    st.success("‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!")
                    st.markdown("### üì∏ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å AI:")
                    st.write(response.text)
                    
                    # ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡∏à‡∏≥‡∏•‡∏≠‡∏á)
                    st.download_button(
                        label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)",
                        data=uploaded_file.getvalue(),
                        file_name=f"new_{outfit}.png",
                        mime="image/png"
                    )
                except Exception as e:
                    st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")

# --- 6. ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ---
st.divider()
st.info("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: Gemini 1.5 Flash ‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏û ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Inpainting ‡πÄ‡∏ä‡πà‡∏ô Imagen 3 ‡∏´‡∏£‡∏∑‡∏≠ Stable Diffusion ‡∏Ñ‡∏£‡∏±‡∏ö")



